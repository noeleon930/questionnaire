<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Questionnaire</title>
    <link rel="stylesheet" href="../css/foundation.css" />
    <script src="../js/vendor/modernizr.js"></script>
</head>

<body>
    <p> </p>
    <div class="row" style="max-width:100%">
        <div class="medium-1 columns">
            <p> </p>
        </div>
        <div id="questions" class="medium-10 columns">
            <div class="row collapse" v-repeat="questions" id="{{id}}">
                <div class="medium-10 columns">
                    <input type="text" placeholder="Question..." v-model="content" v-on="input: update_content($index)">
                </div>
                <div class="medium-1 columns">
                    <a class="button postfix" style="padding:0px" v-on="click: add_below($index)">Add below</a>
                </div>
                <div class="medium-1 columns">
                    <a class="button postfix alert" style="padding:0px" v-on="click: delete($index)">Delete</a>
                </div>
            </div>
        </div>
        <div class="medium-1 columns">
            <p> </p>
        </div>
    </div>
    <script src="../js/vendor/jquery.js"></script>
    <script src="../js/foundation.min.js"></script>
    <script src="../js/vue.min.js"></script>
    <script>
    $(document).foundation();
    </script>
    <script>
    var q = new Vue({
        el: '#questions',
        data: {
            // content: '',
            questions: []
        },
        ready: function() {
            $.get('../../questions', function(questions) {
                var tmp = questions.map(function(question, i, arr) {
                    question.id = question._id;
                    question.number = i + 1;
                    return question;
                });
                q.questions = tmp;
                console.log(tmp);
            });
        },
        methods: {
            add_below: function(n) {
                console.log('add_below_' + n);
                // console.log(q.questions[n].content)
                if (n + 1 == q.questions.length) {
                    q.questions.push({
                        content: '',
                        aspect: '',
                        number: n + 2
                    });
                } else {
                    q.questions.splice(n + 1, 0, {
                        content: '',
                        aspect: '',
                        number: n + 2
                    });
                }

                // q.questions = q.questions.map(function(item, i, arr) {
                //     item.number = i + 1;
                // });

                $.ajax({
                        url: '../../questions/',
                        method: 'POST',
                        data: {
                            aspect: q.questions[n + 1].aspect,
                            number: n + 1,
                            content: q.questions[n + 1].content
                        }
                    })
                    .done(function(data) {
                        $.get('../../questions', function(questions) {
                            var tmp = questions.map(function(question, i, arr) {
                                question.id = question._id;
                                question.number = i + 1;
                                return question;
                            });
                            q.questions = tmp;
                        });
                    });
            },
            update_content: function(n) {
                console.log('updating_' + n);
                $.ajax({
                        url: '../../questions/' + q.questions[n]._id,
                        method: 'PUT',
                        data: {
                            aspect: q.questions[n].aspect,
                            number: n + 1,
                            content: q.questions[n].content
                        }
                    })
                    .done(function(data) {
                        console.log(data);
                    });
            },
            delete: function(n) {
                console.log('delete_' + n);
                $.ajax({
                        url: '../../questions/' + q.questions[n]._id,
                        method: 'DELETE'
                    })
                    .done(function(data) {
                        q.questions.splice(n, 1);
                        console.log(data);
                    });
            }
        }
    });
    </script>
</body>

</html>
